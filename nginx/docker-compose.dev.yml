version: '3.8'

services:
  nginx:
    image: nginx:alpine
    ports:
      - "3010:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - auth
      - staffs
      - attendance
      - bff
    networks:
      - microservices

  auth:
    build:
      context: ../services/auth
      dockerfile: Dockerfile.dev
    expose:
      - "3001"
    volumes:
      - ../services/auth:/app
      - /app/node_modules
    environment:
      - PORT=3001
      - DATABASE_URL=${AUTH_DATABASE_URL}
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRES_IN=${JWT_EXPIRES_IN}
    networks:
      - microservices

  staffs:
    build:
      context: ../services/staffs
      dockerfile: Dockerfile.dev
    expose:
      - "3002"
    volumes:
      - ../services/staffs:/app
      - /app/node_modules
    environment:
      - PORT=3002
      - DATABASE_URL=${STAFF_DATABASE_URL}
      - JWT_SECRET=${JWT_SECRET}
    networks:
      - microservices

  attendance:
    build:
      context: ../services/attendance
      dockerfile: Dockerfile.dev
    expose:
      - "3000"
    volumes:
      - ../services/attendance:/app
      - /app/node_modules
    environment:
      - PORT=3000
      - DATABASE_URL=${ATTENDANCE_DATABASE_URL}
      - JWT_SECRET=${JWT_SECRET}
      - GCS_PROJECT_ID=${GCS_PROJECT_ID}
      - GCS_BUCKET_NAME=${GCS_BUCKET_NAME}
      - GCS_KEY_FILE=${GCS_KEY_FILE}
      - MAX_FILE_SIZE_MB=${MAX_FILE_SIZE_MB}
    networks:
      - microservices

  bff:
    build:
      context: ../services/bff
      dockerfile: Dockerfile.dev
    expose:
      - "3003"
    volumes:
      - ../services/bff:/app
      - /app/node_modules
    environment:
      - PORT=3003
      - STAFFS_SERVICE_URL=http://staffs:3002
      - ATTENDANCE_SERVICE_URL=http://attendance:3000
      - AUTH_SERVICE_URL=http://auth:3001
      - JWT_SECRET=${JWT_SECRET}
    networks:
      - microservices

  frontend:
    build:
      context: ../frontend/app
      dockerfile: Dockerfile.dev
    expose:
      - "5173"
    ports:
      - "5173:5173"
    volumes:
      - ../frontend/app:/app
      - /app/node_modules
    environment:
      - VITE_API_URL=http://nginx
    networks:
      - microservices

networks:
  microservices:
    driver: bridge
